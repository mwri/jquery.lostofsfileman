// Package: jquery.lostofsfileman v1.0.0 (built 2017-08-24 08:46:40)
// Copyright: (C) 2017 Michael Wright <mjw@methodanalysis.com>
// License: MIT

"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){function t(e,t){var n=t[0];if(n in d)return t[0]=jQuery.data(e,"lostofsfileman"),d[n].apply(e,t);throw'lostofsfileman has no method "'+n+'"'}function n(t,r,d){var s=r.fs,c=r.dir_path,u=t.find("> .lsfsfm_dir");u.find(".lsfsfm_dir_container").off("dragenter").off("dragleave").off("dragover").off("drop");var p=0;r.render_prom=s.get(c).then(function(m){return m.ls().then(function(g){u.empty();var h=e('<div class="lsfsfm_dir_container" data-dir-path="'+c+'"/>');if(u.append(h),!d.no_header){var v=e('<div class="lsfsfm_dir_hdr">Location: '+c+"</div>");h.append(v)}var _=e('<div class="lsfsfm_dir_entlist"/>');h.append(_);var y=e("<table></table>");_.append(y);var b=e("<tbody/>");y.append(b);var w=e('<input type="file" name="files[]" style="display:none;">');h.append(w),w.get(0).addEventListener("change",function(e){var t=e.target.files[0],n=t.name,a=new FileReader;return a.onload=function(e){m.mkfile(n,e.target.result,{mod_time:t.lastModifiedDate,mime_type:t.type,free_name:!0}).catch(function(e){console.log(e),alert("create file failed: "+e)})},a.readAsArrayBuffer(t),!1},!1);var D=e("<table/>");h.append(D),a(t,r,D,s,m,w).easymenu("attach",h),g=g.sort(function(e,t){return e[0].toLowerCase()<t[0].toLowerCase()?-1:e[0].toLowerCase()>t[0].toLowerCase()?1:0});for(var k=0;k<g.length;k++)!function(c){var u=g[c][0],h=g[c][1],v="dir"===h.type()?"lsfsfm_dir_icon":"lsfsfm_ent_icon";"file"===h.type()&&void 0!==h.mime_type()&&(v+=" lsfsfm_"+h.mime_type().replace(/[\/-]/g,"_"));var _=e('<tr class="lsfsfm_ent" draggable="true" data-inode="'+h.inode()+'"/>');b.append(_);var y=e("<td/>");_.append(y);var D=e('<a download="'+u+'" href="#"/>');y.append(D);var k=e("<table/>");y.append(k);var L=e('<span class="'+v+'" data-entname="'+u+'"/>');y.append(L);var C=e("<td/>");_.append(C);var M=e('<span class="lsfsfm_entname" data-entname="'+u+'">'+u+"</span>");C.append(M);var S=e("<td>"+l(h.mod_time())+"</td>");_.append(S);var R=e("dir"===h.type()?"<td/>":"<td>"+f(h.size())+"</td>");_.append(R),a(t,r,k,s,m,w,u,h,_).easymenu("attach",_),M.blur(function(t){o(m,e(t.target))}),_.on("dragstart",function(t){t.originalEvent.dataTransfer.setData("text",t.target.id),e(t.target).addClass("lsfsfm_dragging"),p=0}).on("dragend",function(t){t.preventDefault(),t.stopPropagation(),e(".lsfsfm_dragging").removeClass("lsfsfm_dragging")}),"file"===h.type()?_.on("dblclick",function(t){for(var n=t.target;"TR"!==n.tagName;)n=n.parentElement;return m.get(e(D).attr("download")).then(function(t){return i(D.get(0),t,e(D).attr("download")),!0}).catch(function(e){console.log(e)}),t.preventDefault(),t.stopPropagation(),!1}):_.on("dblclick",function(e){if(".."===u){if("/"!==r.dir_path){var a=/^(.*)\/[^\/]+$/.exec(r.dir_path);a&&(r.dir_path=""===a[1]?"/":a[1],s.get(r.dir_path).then(function(e){r.inode=e.inode(),n(t,r,d)}))}}else"."!==u&&(r.dir_path="/"===r.dir_path?"/"+u:r.dir_path+"/"+u,s.get(r.dir_path).then(function(e){r.inode=e.inode(),n(t,r,d)}))})}(k);h.on("dragenter",function(e){e.preventDefault(),e.stopPropagation(),0===p&&h.addClass("lsfsfm_dir_draghover"),p++}).on("dragleave",function(e){return e.preventDefault(),e.stopPropagation(),0===--p&&h.removeClass("lsfsfm_dir_draghover"),!1}).on("dragover",!1).on("drop",function(t){h.removeClass("lsfsfm_dir_draghover"),p=0,t.preventDefault(),t.stopPropagation();var n=t.originalEvent.dataTransfer.files,a=e(".lsfsfm_dragging");if(n.length>0)for(var r=0;r<n.length;r++){var o=new FileReader;return o.onload=function(e){m.mkfile(n[r].name,e.target.result,{mod_time:n[r].lastModifiedDate,mime_type:n[r].type,free_name:!0}).catch(function(e){console.log(e),alert(e)})},o.readAsArrayBuffer(n[r]),!1}else if(a.length>0){var i=e(".lsfsfm_dragging").find(".lsfsfm_entname").text(),f=e(".lsfsfm_dragging").closest(".lsfsfm_dir_container").attr("data-dir-path");s.get(f).then(function(e){return e.move(i,c+"/"+i)}).catch(function(e){console.log(e),alert(e)})}return!1})})}).catch(function(e){throw console.log(e),e})}function a(e,t,n,a,o,i,f,l,d){var s=[];return s.push({label:"New directory",title:"Create a new directory",callback:function(){o.mkdir("New directory",{free_name:!0}).then(function(n){return t.render_prom.then(function(){r(e.find('.lsfsfm_ent[data-inode="'+n.inode()+'"]'))})}).catch(function(e){console.log(e),console.log(e)})}}),s.push({label:"Upload file",title:"Specify a file for upload to the directory",classes:["lsfsfm_upload"],callback:function(){i.focus().trigger("click")}}),void 0!==l&&(s.push({type:"separator"}),s.push({label:"Rename",title:"Change the name of the file or directory",callback:function(){r(d)}}),s.push({label:"Delete",title:"Delete the file or directory",callback:function(){o.remove(f).catch(function(e){console.log(e),alert(e)})}})),t.menu_shform&&(s.push({type:"separator"}),s.push({label:"Format FS",title:"Format the filesystem, ALL DATA WILL BE LOST!",callback:function(){confirm("ARE YOU SURE? Formatting will ERASE all data! Click OK to proceed or cancel to abort.")&&a.format().catch(function(e){alert(e)})}})),n.easymenu({menu_items:s})}function r(t){var n=t.find(".lsfsfm_entname");n.attr("contenteditable","true").attr("spellcheck","false").attr("data-renaming","true").keypress(function(t){return 13!==t.which||(e(document.activeElement).blur(),!1)}),n.focus(),document.execCommand("selectall",null,!1)}function o(e,t){if("true"===t.attr("data-renaming")){t.attr("data-renaming","false");var n=t.attr("data-entname"),a=t.text();n!==a&&e.move(n,a).then(function(){t.attr("data-entname",a)}).catch(function(e){t.attr("data-entname",n),t.text(n),console.log(e),alert("rename failed: "+e)}),t.attr("contenteditable","false")}}function i(e,t,n){return t.data().then(function(a){var r=t.mime_type()||"application/octet-binary",o=new Blob([a],{type:r}),i=window.URL.createObjectURL(o);e.href=i,e.download=n,e.click(),window.URL.revokeObjectURL(i)}).catch(function(e){console.log(e),alert("file download failed: "+e)})}function f(e){return e>1e9?Math.round(e/1e8)/10+" GB":e>1e6?Math.round(e/1e5)/10+" MB":e>1e3?Math.round(e/100)/10+" KB":e+" bytes"}function l(e){var t=new Date(e),n=new Date,a="";return t.getDate()!==n.getDate()||t.getMonth()!==n.getMonth()||t.getYear()!==n.getYear()?(a+=t.getFullYear(),a+="/",a+=t.getMonth()>9?t.getMonth():"0"+t.getMonth(),a+="/",a+=t.getDate()>9?t.getDate():"0"+t.getDate()):(a+=t.getHours()>9?t.getHours():"0"+t.getHours(),a+=":",a+=t.getMinutes()>9?t.getMinutes():"0"+t.getMinutes(),a+=":",a+=t.getSeconds()>9?t.getSeconds():"0"+t.getSeconds()),a}e.fn.lostofsfileman=function(e){if("string"==typeof e)return t(this,arguments);if("object"===(void 0===e?"undefined":_typeof(e)))return t(this,["constructor",e]);throw"lostofsfileman requires a string (method) or object (constructor) first parameter"};var d={constructor:function(t,a){this.addClass("lsfsfm_fileman");var r=e('<div class="lsfsfm_dir"/>');this.append(r);var o=a.fs,i=a.dir;void 0===i&&(i="/"),t={fs:o,dir_path:i,menu_shform:a.menu_shform||!1},jQuery.data(this,"lostofsfileman",t);var f=this;o.ready().then(function(){o.get(t.dir_path).then(function(e){if("dir"!==e.type())throw'path "'+t.dir_path+'" is not a directory';t.inode=e.inode(),n(f,t,a),o.on("create",function(e,r,o){e.inode()===t.inode&&n(f,t,a)}).on("move",function(e,r,o,i,l){e.inode()!==t.inode&&o.inode()!==t.inode||n(f,t,a)}).on("remove",function(e,r){e.inode()===t.inode&&n(f,t,a)}).on("ready",function(){n(f,t,a)}).on("format",function(){t.dir_path="/"})})})}}}(jQuery);