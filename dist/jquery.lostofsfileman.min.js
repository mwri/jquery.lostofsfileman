// Package: jquery.lostofsfileman v1.0.6 (built 2018-02-13 21:59:14)
// Copyright: (C) 2017 Michael Wright <mjw@methodanalysis.com>
// License: MIT

"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){function t(e,t){var a=t[0];if(a in n)return t[0]=jQuery.data(e,"lostofsfileman"),n[a].apply(e,t);throw'lostofsfileman has no method "'+a+'"'}e.fn.lostofsfileman=function(e){if("string"==typeof e)return t(this,arguments);if("object"===(void 0===e?"undefined":_typeof(e)))return t(this,["constructor",e]);throw"lostofsfileman requires a string (method) or object (constructor) first parameter"};var n={constructor:function(t,n){this.addClass("lsfsfm_fileman");var r=e('<div class="lsfsfm_dir"/>');this.append(r);var o=n.fs,i=n.dir;void 0===i&&(i="/");var f=void 0!==n.single_dir&&n.single_dir,l=void 0!==n.no_header?!n.no_header:!f;t={fs:o,dir_path:i,menu_shform:n.menu_shform||!1,show_hdr:l,single_dir:f,menu_extra:void 0!==n.menu?n.menu:[],file_choose:n.file_choose},jQuery.data(this,"lostofsfileman",t);var d=this;o.ready().then(function(){o.get(t.dir_path).then(function(e){if("dir"!==e.type())throw'path "'+t.dir_path+'" is not a directory';t.inode=e.inode(),a(d,t,n),o.on("create",function(e,r,o){e.inode()===t.inode&&a(d,t,n)}).on("move",function(e,r,o,i,f){e.inode()!==t.inode&&o.inode()!==t.inode||a(d,t,n)}).on("remove",function(e,r){e.inode()===t.inode&&a(d,t,n)}).on("ready",function(){a(d,t,n)}).on("format",function(){t.dir_path="/"})})})},rendered:function(e){return e.render_prom},rename:function(e,t){o(this.find('.lsfsfm_ent[data-entname="'+t+'"]'))},new_file:function(e,t,n,a){return e.fs.get(e.dir_path).then(function(r){return void 0===n&&(n=""),r.mkfile(t,n,a).then(function(t){return e.render_prom.then(function(){return t})})})}};function a(t,n,o){var i=n.fs,f=n.dir_path,l=t.find("> .lsfsfm_dir");l.find(".lsfsfm_dir_container").off("dragenter").off("dragleave").off("dragover").off("drop");var d=0;n.render_prom=i.get(f).then(function(s){return s.ls().then(function(c){l.empty();var u=e('<div class="lsfsfm_dir_container" data-dir-path="'+f+'"/>');if(l.append(u),n.show_hdr){var m=e('<div class="lsfsfm_dir_hdr">Location: '+f+"</div>");u.append(m)}var p=e('<div class="lsfsfm_dir_entlist"/>');u.append(p);var g=e("<table></table>");p.append(g);var h=e("<tbody/>");g.append(h);var _=e('<input type="file" name="files[]" style="display:none;">');u.append(_),_.get(0).addEventListener("change",function(e){var t=e.target.files[0],n=t.name,a=new FileReader;return a.onload=function(e){s.mkfile(n,e.target.result,{mod_time:t.lastModifiedDate,mime_type:t.type,free_name:!0}).catch(function(e){console.log(e),alert("create file failed: "+e)})},a.readAsArrayBuffer(t),!1},!1);var v=e("<table/>");u.append(v),r(t,n,v,i,s,_).easymenu("attach",u),c=c.sort(function(e,t){return e[0].toLowerCase()<t[0].toLowerCase()?-1:e[0].toLowerCase()>t[0].toLowerCase()?1:0});for(var y=function(f){if(n.single_dir&&("."===c[f][0]||".."===c[f][0]))return"continue";var l=c[f][0],u=c[f][1],m="dir"===u.type()?"lsfsfm_dir_icon":"lsfsfm_ent_icon";"file"===u.type()&&void 0!==u.mime_type()&&(m+=" lsfsfm_"+u.mime_type().replace(/[/-]/g,"_"));var p=e('<tr class="lsfsfm_ent" draggable="true" data-inode="'+u.inode()+'" data-entname="'+l+'"/>');h.append(p);var g=e("<td/>");p.append(g);var v=e('<a download="'+l+'" href="#"/>');g.append(v);var y=e("<table/>");g.append(y);var b=e('<span class="'+m+'" data-entname="'+l+'"/>');g.append(b);var w=e("<td/>");p.append(w);var D=e('<span class="lsfsfm_entname" data-entname="'+l+'">'+l+"</span>");w.append(D);var k=e("<td>"+function(e){var t=new Date(e),n=new Date,a="";t.getDate()!==n.getDate()||t.getMonth()!==n.getMonth()||t.getYear()!==n.getYear()?(a+=t.getFullYear(),a+="/",a+=t.getMonth()>9?t.getMonth():"0"+t.getMonth(),a+="/",a+=t.getDate()>9?t.getDate():"0"+t.getDate()):(a+=t.getHours()>9?t.getHours():"0"+t.getHours(),a+=":",a+=t.getMinutes()>9?t.getMinutes():"0"+t.getMinutes(),a+=":",a+=t.getSeconds()>9?t.getSeconds():"0"+t.getSeconds());return a}(u.mod_time())+"</td>");p.append(k);var L,C="dir"===u.type()?e("<td/>"):e("<td>"+((L=u.size())>1e9?Math.round(L/1e8)/10+" GB":L>1e6?Math.round(L/1e5)/10+" MB":L>1e3?Math.round(L/100)/10+" KB":L+" bytes")+"</td>");p.append(C),r(t,n,y,i,s,_,l,u,p).easymenu("attach",p),D.blur(function(t){!function(e,t){if("true"!==t.attr("data-renaming"))return;t.attr("data-renaming","false");var n=t.attr("data-entname"),a=t.text();n!==a&&e.move(n,a).then(function(){t.attr("data-entname",a)}).catch(function(e){t.attr("data-entname",n),t.text(n),console.log(e),alert("move file failed: "+e)});t.attr("contenteditable","false")}(s,e(t.target))}),p.on("dragstart",function(t){t.originalEvent.dataTransfer.setData("text",t.target.id),e(t.target).addClass("lsfsfm_dragging"),d=0}).on("dragend",function(t){t.preventDefault(),t.stopPropagation(),e(".lsfsfm_dragging").removeClass("lsfsfm_dragging")}),"file"===u.type()?p.on("dblclick",function(t){for(var a=t.target;"TR"!==a.tagName;)a=a.parentElement;return s.get(e(v).attr("download")).then(function(t){var a,r,o;return void 0===n.file_choose?(a=v.get(0),r=t,o=e(v).attr("download"),r.data().then(function(e){var t=r.mime_type()||"application/octet-binary",n=new Blob([e],{type:t}),i=window.URL.createObjectURL(n);a.href=i,a.download=o,a.click(),window.URL.revokeObjectURL(i)}).catch(function(e){console.log(e),alert("file download failed: "+e)})):n.file_choose(t,s,l),!0}).catch(function(e){console.log(e),alert("file select failed: "+e)}),t.preventDefault(),t.stopPropagation(),!1}):p.on("dblclick",function(e){if(".."===l){if("/"!==n.dir_path){var r=/^(.*)\/[^/]+$/.exec(n.dir_path);r&&(n.dir_path=""===r[1]?"/":r[1],i.get(n.dir_path).then(function(e){n.inode=e.inode(),a(t,n,o)}))}}else"."!==l&&(n.dir_path="/"===n.dir_path?"/"+l:n.dir_path+"/"+l,i.get(n.dir_path).then(function(e){n.inode=e.inode(),a(t,n,o)}))})},b=0;b<c.length;b++)y(b);u.on("dragenter",function(e){e.preventDefault(),e.stopPropagation(),0===d&&u.addClass("lsfsfm_dir_draghover"),d++}).on("dragleave",function(e){return e.preventDefault(),e.stopPropagation(),0===--d&&u.removeClass("lsfsfm_dir_draghover"),!1}).on("dragover",!1).on("drop",function(t){u.removeClass("lsfsfm_dir_draghover"),d=0,t.preventDefault(),t.stopPropagation();var n=t.originalEvent.dataTransfer.files,a=e(".lsfsfm_dragging");if(n.length>0)for(var r=0;r<n.length;r++){var o=new FileReader;return o.onload=function(e){s.mkfile(n[r].name,e.target.result,{mod_time:n[r].lastModifiedDate,mime_type:n[r].type,free_name:!0}).catch(function(e){console.log(e),alert("create file failed: "+e)})},o.readAsArrayBuffer(n[r]),!1}else if(a.length>0){var l=e(".lsfsfm_dragging").find(".lsfsfm_entname").text(),c=e(".lsfsfm_dragging").closest(".lsfsfm_dir_container").attr("data-dir-path");i.get(c).then(function(e){return e.move(l,f+"/"+l)}).catch(function(e){console.log(e),alert("move file failed: "+e)})}return!1})})}).then(function(){t.trigger("rendered")}).catch(function(e){throw console.log(e),e})}function r(e,t,n,a,r,i,f,l,d){var s=[];if(t.single_dir||s.push({label:"New directory",title:"Create a new directory",callback:function(){r.mkdir("New directory",{free_name:!0}).then(function(n){return t.render_prom.then(function(){o(e.find('.lsfsfm_ent[data-inode="'+n.inode()+'"]'))})}).catch(function(e){console.log(e),console.log(e)})}}),s.push({label:"Upload file",title:"Specify a file for upload to the directory",classes:["lsfsfm_upload"],callback:function(){i.focus().trigger("click")}}),void 0!==l&&(s.push({type:"separator"}),s.push({label:"Rename",title:"Change the name of the file or directory",callback:function(){o(d)}}),s.push({label:"Delete",title:"Delete the file or directory",callback:function(){r.remove(f).catch(function(e){console.log(e),alert("remove file failed: "+e)})}})),t.menu_shform&&(s.push({type:"separator"}),s.push({label:"Format FS",title:"Format the filesystem, ALL DATA WILL BE LOST!",callback:function(){confirm("ARE YOU SURE? Formatting will ERASE all data! Click OK to proceed or cancel to abort.")&&a.format().catch(function(e){alert(e)})}})),t.menu_extra.length>0){s.push({type:"separator"});for(var c=0;c<t.menu_extra.length;c++)s.push(t.menu_extra[c])}return n.easymenu({menu_items:s})}function o(t){var n=t.find(".lsfsfm_entname");n.attr("contenteditable","true").attr("spellcheck","false").attr("data-renaming","true").keypress(function(t){return 13!==t.which||(e(document.activeElement).blur(),!1)}),n.focus(),document.execCommand("selectall",null,!1)}}(jQuery);