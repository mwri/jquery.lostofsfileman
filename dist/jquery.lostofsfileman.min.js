// Package: jquery.lostofsfileman v1.0.2 (built 2017-08-29 18:03:16)
// Copyright: (C) 2017 Michael Wright <mjw@methodanalysis.com>
// License: MIT

"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){function t(e,t){var n=t[0];if(n in l)return t[0]=jQuery.data(e,"lostofsfileman"),l[n].apply(e,t);throw'lostofsfileman has no method "'+n+'"'}function n(t,r,l){var s=r.fs,c=r.dir_path,u=t.find("> .lsfsfm_dir");u.find(".lsfsfm_dir_container").off("dragenter").off("dragleave").off("dragover").off("drop");var p=0;r.render_prom=s.get(c).then(function(m){return m.ls().then(function(h){u.empty();var g=e('<div class="lsfsfm_dir_container" data-dir-path="'+c+'"/>');if(u.append(g),r.show_hdr){var _=e('<div class="lsfsfm_dir_hdr">Location: '+c+"</div>");g.append(_)}var v=e('<div class="lsfsfm_dir_entlist"/>');g.append(v);var y=e("<table></table>");v.append(y);var b=e("<tbody/>");y.append(b);var w=e('<input type="file" name="files[]" style="display:none;">');g.append(w),w.get(0).addEventListener("change",function(e){var t=e.target.files[0],n=t.name,a=new FileReader;return a.onload=function(e){m.mkfile(n,e.target.result,{mod_time:t.lastModifiedDate,mime_type:t.type,free_name:!0}).catch(function(e){console.log(e),alert("create file failed: "+e)})},a.readAsArrayBuffer(t),!1},!1);var D=e("<table/>");g.append(D),a(t,r,D,s,m,w).easymenu("attach",g),h=h.sort(function(e,t){return e[0].toLowerCase()<t[0].toLowerCase()?-1:e[0].toLowerCase()>t[0].toLowerCase()?1:0});for(var k=0;k<h.length;k++){(function(c){if(r.single_dir&&("."===h[c][0]||".."===h[c][0]))return"continue";var u=h[c][0],g=h[c][1],_="dir"===g.type()?"lsfsfm_dir_icon":"lsfsfm_ent_icon";"file"===g.type()&&void 0!==g.mime_type()&&(_+=" lsfsfm_"+g.mime_type().replace(/[\/-]/g,"_"));var v=e('<tr class="lsfsfm_ent" draggable="true" data-inode="'+g.inode()+'" data-entname="'+u+'"/>');b.append(v);var y=e("<td/>");v.append(y);var D=e('<a download="'+u+'" href="#"/>');y.append(D);var k=e("<table/>");y.append(k);var L=e('<span class="'+_+'" data-entname="'+u+'"/>');y.append(L);var C=e("<td/>");v.append(C);var M=e('<span class="lsfsfm_entname" data-entname="'+u+'">'+u+"</span>");C.append(M);var S=e("<td>"+d(g.mod_time())+"</td>");v.append(S);var R=e("dir"===g.type()?"<td/>":"<td>"+f(g.size())+"</td>");v.append(R),a(t,r,k,s,m,w,u,g,v).easymenu("attach",v),M.blur(function(t){o(m,e(t.target))}),v.on("dragstart",function(t){t.originalEvent.dataTransfer.setData("text",t.target.id),e(t.target).addClass("lsfsfm_dragging"),p=0}).on("dragend",function(t){t.preventDefault(),t.stopPropagation(),e(".lsfsfm_dragging").removeClass("lsfsfm_dragging")}),"file"===g.type()?v.on("dblclick",function(t){for(var n=t.target;"TR"!==n.tagName;)n=n.parentElement;return m.get(e(D).attr("download")).then(function(t){return void 0===r.file_choose?i(D.get(0),t,e(D).attr("download")):r.file_choose(t),!0}).catch(function(e){console.log(e)}),t.preventDefault(),t.stopPropagation(),!1}):v.on("dblclick",function(e){if(".."===u){if("/"!==r.dir_path){var a=/^(.*)\/[^\/]+$/.exec(r.dir_path);a&&(r.dir_path=""===a[1]?"/":a[1],s.get(r.dir_path).then(function(e){r.inode=e.inode(),n(t,r,l)}))}}else"."!==u&&(r.dir_path="/"===r.dir_path?"/"+u:r.dir_path+"/"+u,s.get(r.dir_path).then(function(e){r.inode=e.inode(),n(t,r,l)}))})})(k)}g.on("dragenter",function(e){e.preventDefault(),e.stopPropagation(),0===p&&g.addClass("lsfsfm_dir_draghover"),p++}).on("dragleave",function(e){return e.preventDefault(),e.stopPropagation(),0===--p&&g.removeClass("lsfsfm_dir_draghover"),!1}).on("dragover",!1).on("drop",function(t){g.removeClass("lsfsfm_dir_draghover"),p=0,t.preventDefault(),t.stopPropagation();var n=t.originalEvent.dataTransfer.files,a=e(".lsfsfm_dragging");if(n.length>0)for(var r=0;r<n.length;r++){var o=new FileReader;return o.onload=function(e){m.mkfile(n[r].name,e.target.result,{mod_time:n[r].lastModifiedDate,mime_type:n[r].type,free_name:!0}).catch(function(e){console.log(e),alert(e)})},o.readAsArrayBuffer(n[r]),!1}else if(a.length>0){var i=e(".lsfsfm_dragging").find(".lsfsfm_entname").text(),f=e(".lsfsfm_dragging").closest(".lsfsfm_dir_container").attr("data-dir-path");s.get(f).then(function(e){return e.move(i,c+"/"+i)}).catch(function(e){console.log(e),alert(e)})}return!1})})}).catch(function(e){throw console.log(e),e})}function a(e,t,n,a,o,i,f,d,l){var s=[];if(t.single_dir||s.push({label:"New directory",title:"Create a new directory",callback:function(){o.mkdir("New directory",{free_name:!0}).then(function(n){return t.render_prom.then(function(){r(e.find('.lsfsfm_ent[data-inode="'+n.inode()+'"]'))})}).catch(function(e){console.log(e),console.log(e)})}}),s.push({label:"Upload file",title:"Specify a file for upload to the directory",classes:["lsfsfm_upload"],callback:function(){i.focus().trigger("click")}}),void 0!==d&&(s.push({type:"separator"}),s.push({label:"Rename",title:"Change the name of the file or directory",callback:function(){r(l)}}),s.push({label:"Delete",title:"Delete the file or directory",callback:function(){o.remove(f).catch(function(e){console.log(e),alert(e)})}})),t.menu_shform&&(s.push({type:"separator"}),s.push({label:"Format FS",title:"Format the filesystem, ALL DATA WILL BE LOST!",callback:function(){confirm("ARE YOU SURE? Formatting will ERASE all data! Click OK to proceed or cancel to abort.")&&a.format().catch(function(e){alert(e)})}})),t.menu_extra.length>0){s.push({type:"separator"});for(var c=0;c<t.menu_extra.length;c++)s.push(t.menu_extra[c])}return n.easymenu({menu_items:s})}function r(t){var n=t.find(".lsfsfm_entname");n.attr("contenteditable","true").attr("spellcheck","false").attr("data-renaming","true").keypress(function(t){return 13!==t.which||(e(document.activeElement).blur(),!1)}),n.focus(),document.execCommand("selectall",null,!1)}function o(e,t){if("true"===t.attr("data-renaming")){t.attr("data-renaming","false");var n=t.attr("data-entname"),a=t.text();n!==a&&e.move(n,a).then(function(){t.attr("data-entname",a)}).catch(function(e){t.attr("data-entname",n),t.text(n),console.log(e),alert("rename failed: "+e)}),t.attr("contenteditable","false")}}function i(e,t,n){return t.data().then(function(a){var r=t.mime_type()||"application/octet-binary",o=new Blob([a],{type:r}),i=window.URL.createObjectURL(o);e.href=i,e.download=n,e.click(),window.URL.revokeObjectURL(i)}).catch(function(e){console.log(e),alert("file download failed: "+e)})}function f(e){return e>1e9?Math.round(e/1e8)/10+" GB":e>1e6?Math.round(e/1e5)/10+" MB":e>1e3?Math.round(e/100)/10+" KB":e+" bytes"}function d(e){var t=new Date(e),n=new Date,a="";return t.getDate()!==n.getDate()||t.getMonth()!==n.getMonth()||t.getYear()!==n.getYear()?(a+=t.getFullYear(),a+="/",a+=t.getMonth()>9?t.getMonth():"0"+t.getMonth(),a+="/",a+=t.getDate()>9?t.getDate():"0"+t.getDate()):(a+=t.getHours()>9?t.getHours():"0"+t.getHours(),a+=":",a+=t.getMinutes()>9?t.getMinutes():"0"+t.getMinutes(),a+=":",a+=t.getSeconds()>9?t.getSeconds():"0"+t.getSeconds()),a}e.fn.lostofsfileman=function(e){if("string"==typeof e)return t(this,arguments);if("object"===(void 0===e?"undefined":_typeof(e)))return t(this,["constructor",e]);throw"lostofsfileman requires a string (method) or object (constructor) first parameter"};var l={constructor:function(t,a){this.addClass("lsfsfm_fileman");var r=e('<div class="lsfsfm_dir"/>');this.append(r);var o=a.fs,i=a.dir;void 0===i&&(i="/");var f=void 0!==a.single_dir&&a.single_dir,d=void 0!==a.no_header?!a.no_header:!f;t={fs:o,dir_path:i,menu_shform:a.menu_shform||!1,show_hdr:d,single_dir:f,menu_extra:void 0!==a.menu?a.menu:[],file_choose:a.file_choose},jQuery.data(this,"lostofsfileman",t);var l=this;o.ready().then(function(){o.get(t.dir_path).then(function(e){if("dir"!==e.type())throw'path "'+t.dir_path+'" is not a directory';t.inode=e.inode(),n(l,t,a),o.on("create",function(e,r,o){e.inode()===t.inode&&n(l,t,a)}).on("move",function(e,r,o,i,f){e.inode()!==t.inode&&o.inode()!==t.inode||n(l,t,a)}).on("remove",function(e,r){e.inode()===t.inode&&n(l,t,a)}).on("ready",function(){n(l,t,a)}).on("format",function(){t.dir_path="/"})})})},rendered:function(e){return e.render_prom},rename:function(e,t){r(this.find('.lsfsfm_ent[data-entname="'+t+'"]'))},new_file:function(e,t,n,a){return e.fs.get(e.dir_path).then(function(r){return void 0===n&&(n=""),r.mkfile(t,n,a).then(function(t){return e.render_prom.then(function(){return t})})})}}}(jQuery);